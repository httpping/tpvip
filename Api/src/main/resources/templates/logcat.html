<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WebSocket Logger</title>
    <!--<script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.js"></script>-->
    <!--<script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>-->
    <!--<script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>-->
    <!-- Bootstrap -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js" ></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">


    <style>

        a {
            color: red;
        }

        hr{
            background-color: snow;
        }

        body{height:100%}


    </style>

</head>
<body style="height: 100%;"  >
<div style="margin: 10px 10px 10px 20px;" class="form-row align-items-center">
    <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
        <div class="btn-group mr-2" role="group" aria-label="First group">
            <button onclick="openSocket()" type="button" class="btn btn-outline-secondary">开启日志</button>
            <button onclick="closeWebSocket()" type="button" class="btn btn-outline-secondary">关闭日志</button>
            <button onclick="clearLog()" type="button" class="btn btn-outline-secondary">清除日志</button>
        </div>
        <div class="btn-group mr-2" role="group" aria-label="Second group">

            <button onclick="openOld()" type="button" class="btn btn-outline-success">历史日志</button>
            <button onclick="modelControler()" type="button" class="btn btn-outline-success">接口模拟</button>
        </div>
        <div class="btn-group" role="group" aria-label="Third group">

            <button onclick="openApi()" type="button" class="btn btn-outline-dark">API 接入</button>
            <button onclick="druidControler()" type="button" class="btn btn-outline-dark">性能监控</button>
        </div>
    </div>

&nbsp;&nbsp;&nbsp;<!-- 用户过滤id:--><input type="hidden" id="user_id" value="" onchange="userIdChange()"/>

    &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
<div class="col-auto my-1">
    <select class="custom-select mr-sm-2" id="cur_system" onchange="levelChange()">
        <option value="0">Choose...</option>
        <option value="1">Android</option>
        <option value="2">iOS</option>

    </select>
</div>
<!--<input type="checkbox" id="android" onchange="levelChange()" > Android </input> &nbsp;&nbsp;-->
<!--<input type="checkbox" id="ios" onchange="levelChange()">iOS</input>-->
&nbsp;&nbsp; <input type="text" id="platform_name" onchange="plfatformChange()"  placeholder="平台过滤"/>
&nbsp;&nbsp; <input type="text" id="url_path" value="" onchange="urlChange()" placeholder="关键字过滤"/>
&nbsp; <input id="text" type="text" placeholder="匿名勾搭" onkeydown="send()"/>
</div>
<!--<hr/>-->
<div id="log-container" style="height: 870px; width: 99%;  overflow-y: scroll; background: #333; color: #aaa; padding: 12px;">
    <div id="log_content"></div>
</div>
<script>
    $(document).ready(function () {
        openSocket();
    });

    $("#cur_system").ready(function () {
        //通过key来获取value
        var dt = sessionStorage.getItem("user_id");
        $("#user_id").val(dt);

        var platform = sessionStorage.getItem("platform_name");
        $("#platform_name").val(platform);


        var url_path = sessionStorage.getItem("url_path");
        $("#url_path").val(url_path);


        var level = sessionStorage.getItem("level")
        if (level == null){
            level = 0;
        }
        $("#cur_system").prop("value",level);

        // $("cur_system").val(level)
        // $("cur_system").options[level].selected = true;
        // alert(level)

    });


    //打开socket
    var websocket = null;

    function openSocket() {
        /*<![CDATA[*/

        if (websocket != null) {
            closeWebSocket()
        }

        var curHost = window.location.href;
        var parser = document.createElement('a');
        parser.href = curHost

        //判断当前浏览器是否支持WebSocket
        if ('WebSocket' in window) {
            websocket = new WebSocket("ws://" + parser.host + "/websocket");
        }
        else {
            alert('Not support websocket')
        }

        //连接发生错误的回调方法
        websocket.onerror = function () {
            setMessageInnerHTML("连接出错了...");
            alert("连接出错了...")
        };

        //连接成功建立的回调方法
        websocket.onopen = function (event) {
            setMessageInnerHTML("连接成功了...");
            alert("连接成功了...")
        }

        //接收到消息的回调方法
        websocket.onmessage = function (event) {
            setMessageInnerHTML(event.data);
        }

        //连接关闭的回调方法
        websocket.onclose = function () {
            setMessageInnerHTML("连接关闭了...");
            alert("连接关闭了...")
        }

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            websocket.close();
        }

        /*]]>*/

    }


    //关闭连接
    function closeWebSocket() {
        websocket.close();
    }

    //发送消息
    function send() {
//        alert(event.keyCode())
        if(event.keyCode == "13") {
            var message = document.getElementById('text').value;
            websocket.send( message  + "." );
        }
    }


    function clearLog() {
        $("#log-container div").empty();
    }

    function isNull(data) {
        return (data == "" || data == undefined || data == null) ? true : false;
    }


    function userIdChange() {
        var user_id_val = $("#user_id").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("user_id", user_id_val);
    }

    function plfatformChange() {
        var platform = $("#platform_name").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("platform_name", platform);
    }

    function urlChange() {
        var url_path = $("#url_path").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("url_path", url_path);
    }


    function levelChange() {

        var curSys = $("#cur_system").val();
        // alert(curSys)
        sessionStorage.setItem("level",curSys);

    }

    function openOld() {
        window.open('/api')
    }

    function druidControler() {
        window.open('/druid')
    }

    function modelControler() {
        window.open('/model')
    }

    /**
     * 接入方法
     */
    function openApi() {
        window.open('/swagger-ui.html')
    }


    var max_logs = 35;
    var number = 1;

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        var content
        try {
            content = JSON.parse(innerHTML);
        }
        catch (err) {
            // alert(innerHTML)

            var str = "<div>" + "<span style='color: red;'>来自远方的消息： </span>" + "<span> "+innerHTML +"</span>" +"<br/>" +"</div>"
            $("#log_content").append(str)

            $("#log_content").scrollTop($("#log_content").height() - $("#log-container").height());

            var lenth = $("#log_content").children().length;
            if (lenth >max_logs){
                $("#log_content").children().first().remove()
            }

            return
        }


        var ios = $('#ios').is(":checked");
        var android = $('#android').is(":checked");

        var level =  $("#cur_system").val();
        if (level != 0){
            if (level == 2) {
                if (content.level.toLowerCase().indexOf("ios") < 0) {
                    return;
                }
            }
            if (level == 1) {
                if (content.level.toLowerCase().indexOf("android") < 0) {
                    return;
                }
            }
        }

        // alert(ios +" -" + android )
        var user_id_val = $("#user_id").val(); //获取
        if (!isNull(user_id_val)) {
            /*if (user_id_val != content.userId) {
                return;
            }*/
        }

        var platform_name = $("#platform_name").val(); //获取
        if (!isNull(platform_name)) {
            if (platform_name != content.platform) {
                return;
            }
        }

        var url_path = sessionStorage.getItem("url_path");
        if (!isNull(url_path)) {
            if (content.body.toLowerCase().indexOf(url_path.toLowerCase()) < 0) {
                return;
            }

        }
        //过滤掉.google链接
        if (content.url !=null && content.url.toLowerCase().indexOf('\.google')>0) {
            return
        }


        var str = "<div>" + "<div> ------ " + content.level + " : " + content.timestamp + " ------ </div>"
            + "<div>" + content.body +"</div>" +"<br/>" + "</div>"

        $("#log_content").append(str)


        $("#log-container").scrollTop($("#log_content").height() - $("#log-container").height());
        // $("#log-container div").removeChild( $("#log-container div").firstChild());
        var lenth = $("#log_content").children().length;
        if (lenth >max_logs){
            $("#log_content").children().first().remove()
        }

        number++;
        if (number >= 100) {
            number = 0;
           // document.getElementById('message').innerHTML = '<br/>';
        }
    }


</script>

</body>
</html>