<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WebSocket Logger</title>
    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.js"></script>
    <script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
    <!-- Bootstrap -->

    <style>

        a {
            color: red;
        }

        body{height:100%}


    </style>

</head>
<body style="height: 100%;">
<button onclick="openSocket()">开启日志</button>
<button onclick="closeWebSocket()">关闭日志</button> &nbsp;&nbsp;
<button onclick="clearLog()">清除日志</button>
<button onclick="openOld()" style="color: blue;">历史日志(new)</button>
<button onclick="openApi()">API 接入</button>
<button onclick="druidControler()">性能监控</button>
<button onclick="modelControler()">接口模拟</button>


&nbsp;&nbsp;&nbsp; 用户过滤id:<input type="text" id="user_id" value="" onchange="userIdChange()"/>
<input type="checkbox" id="android" checked="checked" onchange="levelChange()"> android </input> &nbsp;&nbsp;
<input type="checkbox" id="ios" onchange="levelChange()">ios</input>
&nbsp;&nbsp;&nbsp; 平台过滤:<input type="text" id="platform_name" onchange="plfatformChange()"/>
&nbsp;&nbsp;&nbsp; 关键字过滤:<input type="text" id="url_path" value="" onchange="urlChange()"/>
&nbsp; <input id="text" type="text" placeholder="匿名勾搭" onkeydown="send()"/>
</div>
<hr/>
<div id="log-container" style="height: 880px; width: 99%;  overflow-y: scroll; background: #333; color: #aaa; padding: 10px;">
    <div id="log_content"></div>
</div>
<script>
    $(document).ready(function () {
        openSocket();
    });

    $("#android").ready(function () {
        //通过key来获取value
        var dt = sessionStorage.getItem("user_id");
        $("#user_id").val(dt);

        var platform = sessionStorage.getItem("platform_name");
        $("#platform_name").val(platform);

        // if (isNull(platform)){
        //     $("#platform_name").val("DL");
        // }

        var url_path = sessionStorage.getItem("url_path");
        $("#url_path").val(url_path);

        var ios = sessionStorage.getItem("level_ios")
        var android = sessionStorage.getItem("level_android")
        if (ios == 'true') {
            $('#ios').prop('checked', true);
        }
        if (android == 'true') {
            $('#android').prop('checked', true);
        }
    });


    //打开socket
    var websocket = null;

    function openSocket() {
        /*<![CDATA[*/

        if (websocket != null) {
            closeWebSocket()
        }

        var curHost = window.location.href;
        var parser = document.createElement('a');
        parser.href = curHost

        //判断当前浏览器是否支持WebSocket
        if ('WebSocket' in window) {
            websocket = new WebSocket("ws://" + parser.host + "/websocket");
        }
        else {
            alert('Not support websocket')
        }

        //连接发生错误的回调方法
        websocket.onerror = function () {
            setMessageInnerHTML("连接出错了...");
        };

        //连接成功建立的回调方法
        websocket.onopen = function (event) {
            setMessageInnerHTML("连接成功了...");
        }

        //接收到消息的回调方法
        websocket.onmessage = function (event) {
            setMessageInnerHTML(event.data);
        }

        //连接关闭的回调方法
        websocket.onclose = function () {
            setMessageInnerHTML("连接关闭了...");
        }

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            websocket.close();
        }

        /*]]>*/

    }


    //关闭连接
    function closeWebSocket() {
        websocket.close();
    }

    //发送消息
    function send() {
//        alert(event.keyCode())
        if(event.keyCode == "13") {
            var message = document.getElementById('text').value;
            websocket.send( message  + "." );
        }
    }


    function clearLog() {
        $("#log-container div").empty();
    }

    function isNull(data) {
        return (data == "" || data == undefined || data == null) ? true : false;
    }


    function userIdChange() {
        var user_id_val = $("#user_id").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("user_id", user_id_val);
    }

    function plfatformChange() {
        var platform = $("#platform_name").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("platform_name", platform);
    }

    function urlChange() {
        var url_path = $("#url_path").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("url_path", url_path);
    }


    function levelChange() {
        var user_id_val = $("#user_id").val(); //获取
        //添加key-value 数据到 sessionStorage
        sessionStorage.setItem("user_id", user_id_val);


        var ios = $('#ios').is(":checked");
        var android = $('#android').is(":checked");

        sessionStorage.setItem("level_ios", ios);
        sessionStorage.setItem("level_android", android);
    }

    function openOld() {

        window.location.href = "/api"
    }

    function druidControler() {

        window.location.href = "/druid"
    }

    function modelControler() {

        window.location.href = "/model"
    }

    /**
     * 接入方法
     */
    function openApi() {
         window.location.href = "/swagger-ui.html"
    }


    var number = 1;

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {

        var content
        try {
            content = JSON.parse(innerHTML);
        }
        catch (err) {
            // alert(innerHTML)
            $("#log_content").append("<span style='color: red;'>来自远方的消息： </span>");
            $("#log_content").append("<span> "+innerHTML +"</span>").append("<br/>");
            $("#log_content").scrollTop($("#log_content").height() - $("#log-container").height());


            return
        }


        var ios = $('#ios').is(":checked");
        var android = $('#android').is(":checked");


        if (ios && android) {
            //todo
        } else {
            if (ios) {
                if (content.level.toLowerCase().indexOf("ios") < 0) {
                    return;
                }
            }
            if (android) {
                if (content.level.toLowerCase().indexOf("android") < 0) {
                    return;
                }
            }

        }
        // alert(ios +" -" + android )
        var user_id_val = $("#user_id").val(); //获取
        if (!isNull(user_id_val)) {
            if (user_id_val != content.userId) {
                return;
            }
        }

        var platform_name = $("#platform_name").val(); //获取
        if (!isNull(platform_name)) {
            if (platform_name != content.platform) {
                return;
            }
        }
        var url_path = sessionStorage.getItem("url_path");
        if (!isNull(url_path)) {
            if (content.body.toLowerCase().indexOf(url_path.toLowerCase()) < 0) {
                return;
            }
        }


        var str = "<div>" + "<div> ------ " + content.level + " : " + content.timestamp + " ------ </div>" + "<br/>"
            + "<div>" + content.body +"</div>" +"<br/>" + "</div>"

        $("#log_content").append(str)


        $("#log-container").scrollTop($("#log_content").height() - $("#log-container").height());
        // $("#log-container div").removeChild( $("#log-container div").firstChild());

        var lenth = $("#log_content").children().length;
        alert(lenth)

        while (lenth >30){
            $("#log_content").children().first().remove()
        }

        number++;
        if (number >= 100) {
            number = 0;
           // document.getElementById('message').innerHTML = '<br/>';
        }
    }


</script>

</body>
</html>